name: Build Fish Slackware Package

# Trigger only on tag push, e.g., v4.0.8
on:
  push:
    tags:
      - 'v*.*.*'

  schedule:
     - cron: '0 4 * * *'  # every day at 04:00 UTC      

permissions:
  contents: write  # needed to create releases

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget xz-utils jq fakeroot

      - name: Get latest Fish release URL
        id: get_url
        run: |
          # Fetch latest release info
          url=$(wget -qO- https://api.github.com/repos/fish-shell/fish-shell/releases/latest \
            | jq -r '.assets[] | select(.name | test("linux-x86_64\\.tar\\.xz$")) | .browser_download_url')
          if [ -z "$url" ]; then
            echo "No x86_64 asset found!" >&2
            exit 1
          fi
          filename=$(basename "$url")
          # Extract version number from filename
          version=$(echo "$filename" | sed -E 's/fish-([0-9.]+)-linux-x86_64\.tar\.xz/\1/')
          echo "url=$url" >> $GITHUB_ENV
          echo "filename=$filename" >> $GITHUB_ENV
          echo "version=$version" >> $GITHUB_ENV

      - name: Download fish tarball
        run: wget -q ${{ env.url }} -O fish.tar.xz

      - name: Extract fish binary
        run: |
          mkdir fishpkg
          tar -xJf fish.tar.xz -C fishpkg
          mkdir -p pkg/usr/bin
          cp fishpkg/fish pkg/usr/bin/fish
          chmod 755 pkg/usr/bin/fish

      - name: Add install scripts
        run: |
          mkdir -p pkg/install
          cp install/doinst.sh pkg/install/
          cp install/slack-desc pkg/install/

      - name: Build Slackware .txz package
        run: |
          cd pkg
          fakeroot tar cvf ../fish-${{ env.version }}-x86_64-1_da.tar *
          cd ..
          xz -z -9 -e fish-${{ env.version }}-x86_64-1_da.tar
          mv fish-${{ env.version }}-x86_64-1_da.tar.xz fish-${{ env.version }}-x86_64-1_da.txz

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: fish-txz
          path: fish-*.txz

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Fish ${{ env.version }} Slackware Package"
          files: fish-*.txz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
