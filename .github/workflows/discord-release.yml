name: Notify Discord on Release

on:
  release:
    types: [published]

jobs:
  discord_notification:
    runs-on: ubuntu-latest
    steps:
      - name: Send release embed to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          TAG: ${{ github.event.release.tag_name }}
          NAME: ${{ github.event.release.name }}
          URL: ${{ github.event.release.html_url }}
          USER: ${{ github.event.release.author.login }}
          BODY: ${{ github.event.release.body }}
        run: |
          DESCRIPTION=$(echo "${BODY:-}" | head -c 300 | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          [ -z "$DESCRIPTION" ] && DESCRIPTION="*(No changelog provided)*"

          JSON=$(cat <<EOF
          {
            "content": "ðŸš€ **New Release: ${TAG}**",
            "embeds": [
              {
                "title": "${NAME:-Release ${TAG}}",
                "url": "${URL}",
                "description": "${DESCRIPTION}",
                "color": 3447003,
                "fields": [
                  {
                    "name": "Author",
                    "value": "${USER}",
                    "inline": true
                  }
                ],
                "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
              }
            ]
          }
          EOF
          )

          curl -H "Content-Type: application/json" -d "$JSON" "$WEBHOOK"
