name: Universal Discord Notifier

on:
  release:
    types: [published, created]
  pull_request:
    types: [opened, closed, reopened]
  issues:
    types: [opened, closed, reopened]
  workflow_run:
    workflows: ["Auto Build & Release Fish Slackware Package"]
    types: [completed]
  workflow_dispatch:

jobs:
  notify_discord:
    runs-on: ubuntu-latest
    steps:
      - name: Get latest release
        id: latest_release
        run: |
          latest_tag=$(curl -s https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest | jq -r '.tag_name // empty' 2>/dev/null || echo "N/A")
          latest_name=$(curl -s https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest | jq -r '.name // empty' 2>/dev/null || echo "N/A")
          latest_tag="${latest_tag:-N/A}"
          latest_name="${latest_name:-N/A}"
          echo "latest_tag=$latest_tag" >> $GITHUB_ENV
          echo "latest_name=$latest_name" >> $GITHUB_ENV

      - name: Send Discord Notification
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          EVENT: ${{ github.event_name }}
          ACTION: ${{ github.event.action || '' }}
          ACTOR: ${{ github.actor }}
          REPO: ${{ github.repository }}
          LATEST_RELEASE_NAME: ${{ env.latest_name || 'N/A' }}
          LATEST_RELEASE_TAG: ${{ env.latest_tag || 'N/A' }}
          # Release info
          RELEASE_NAME: ${{ github.event.release.name || '' }}
          RELEASE_TAG: ${{ github.event.release.tag_name || '' }}
          RELEASE_URL: ${{ github.event.release.html_url || '' }}
          RELEASE_BODY: ${{ github.event.release.body || '' }}
          # PR/Issue info
          PR_TITLE: ${{ github.event.pull_request.title || '' }}
          PR_URL: ${{ github.event.pull_request.html_url || '' }}
          PR_BODY: ${{ github.event.pull_request.body || '' }}
          PR_MERGED: ${{ github.event.pull_request.merged || '' }}
          ISSUE_TITLE: ${{ github.event.issue.title || '' }}
          ISSUE_URL: ${{ github.event.issue.html_url || '' }}
          ISSUE_BODY: ${{ github.event.issue.body || '' }}
          # Workflow run info
          WORKFLOW_NAME: ${{ github.event.workflow_run.name || '' }}
          WORKFLOW_CONCLUSION: ${{ github.event.workflow_run.conclusion || '' }}
          WORKFLOW_URL: ${{ github.event.workflow_run.html_url || '' }}
          BUILT_VERSION: ${{ github.event.workflow_run.outputs.release_tag || '' }}
          NEW_RELEASE: ${{ github.event.workflow_run.outputs.new_release || '' }}
        run: |
          # Fallback for release info
          RELEASE_NAME="${RELEASE_NAME:-${LATEST_RELEASE_NAME:-N/A}}"
          RELEASE_TAG="${RELEASE_TAG:-${BUILT_VERSION:-${LATEST_RELEASE_TAG:-N/A}}}"

          # Initialize variables
          URL=""
          TITLE=""
          BODY=""
          CONTENT=""
          COLOR=8421504
          ICON="üß≠"

          # Determine event type
          case "$EVENT" in
            release)
              URL="${RELEASE_URL}"
              TITLE="${RELEASE_NAME:-Release $RELEASE_TAG}"
              BODY="${BODY:-}$(echo "${RELEASE_BODY}" | head -c 300)"
              COLOR=3447003
              ICON="üöÄ"
              CONTENT="**New Release Published**"
              ;;
            pull_request)
              URL="${PR_URL}"
              TITLE="${PR_TITLE:-Pull Request}"
              BODY="$(echo "${PR_BODY}" | head -c 300)"
              if [ "$ACTION" = "opened" ]; then
                COLOR=5763719
                ICON="üîÄ"
                CONTENT="**Pull Request Opened**"
              elif [ "$ACTION" = "closed" ] && [ "${PR_MERGED}" = "true" ]; then
                COLOR=8311585
                ICON="üéâ"
                CONTENT="**Pull Request Merged!**"
              else
                COLOR=10038562
                ICON="‚ùå"
                CONTENT="**Pull Request Closed**"
              fi
              ;;
            issues)
              URL="${ISSUE_URL}"
              TITLE="${ISSUE_TITLE:-Issue}"
              BODY="$(echo "${ISSUE_BODY}" | head -c 300)"
              if [ "$ACTION" = "opened" ]; then
                COLOR=16776960
                ICON="üêû"
                CONTENT="**New Issue Opened**"
              elif [ "$ACTION" = "closed" ]; then
                COLOR=10038562
                ICON="‚úÖ"
                CONTENT="**Issue Closed**"
              else
                COLOR=9807270
                ICON="üåÄ"
                CONTENT="**Issue Reopened**"
              fi
              ;;
            workflow_run)
              URL="${WORKFLOW_URL:-https://github.com/${REPO}/actions}"
              TITLE="${WORKFLOW_NAME:-Workflow Run}"
              BODY="Workflow '${WORKFLOW_NAME}' completed with conclusion: ${WORKFLOW_CONCLUSION}"
              # Append built version if available
              if [ "$BUILT_VERSION" != "" ]; then
                BODY="$BODY"$'\n'"Built Version: $BUILT_VERSION"
                TITLE="$TITLE ‚Äî $BUILT_VERSION"
              fi
              if [ "$WORKFLOW_CONCLUSION" = "success" ]; then
                COLOR=5763719
                ICON="‚úÖ"
                CONTENT="**Workflow Succeeded**"
              else
                COLOR=10038562
                ICON="‚ùå"
                CONTENT="**Workflow Failed**"
              fi
              ;;
            *)
              URL="https://github.com/${REPO}"
              TITLE="Manual Trigger"
              BODY="Workflow manually triggered by ${ACTOR}"
              COLOR=8421504
              ICON="üß≠"
              CONTENT="**Manual Trigger**"
              ;;
          esac

          # ‚úÖ Skip notification if no release built
          if [ "$EVENT" = "workflow_run" ] && [ "$WORKFLOW_CONCLUSION" = "success" ] && [ -z "$BUILT_VERSION" ]; then
            echo "‚úÖ Workflow succeeded but no new release ‚Äî skipping Discord notification."
            exit 0
          fi

          # Escape quotes and newlines
          TITLE_ESC=$(echo "$TITLE" | sed 's/"/\\"/g')
          BODY_ESC=$(echo "${BODY:-(No content)}" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Escape variables
          ACTOR_ESC=$(echo "$ACTOR" | sed 's/"/\\"/g')
          RELEASE_TAG_ESC=$(echo "$RELEASE_TAG" | sed 's/"/\\"/g')
          RELEASE_NAME_ESC=$(echo "$RELEASE_NAME" | sed 's/"/\\"/g')
          REPO_ESC=$(echo "$REPO" | sed 's/"/\\"/g')

          # Build fields array conditionally
          FIELDS="["
          FIELDS+="{\"name\": \"Repository\", \"value\": \"${REPO_ESC}\", \"inline\": true},"
          FIELDS+="{\"name\": \"Actor\", \"value\": \"${ACTOR_ESC}\", \"inline\": true}"

          if [ "$EVENT" = "release" ]; then
            FIELDS+=",{\"name\": \"Release Tag\", \"value\": \"${RELEASE_TAG_ESC}\", \"inline\": true}"
            FIELDS+=",{\"name\": \"Release Name\", \"value\": \"${RELEASE_NAME_ESC}\", \"inline\": true}"
          fi

          FIELDS+="]"

          # Build JSON
          JSON=$(cat <<EOF
          {
            "content": "${ICON} ${CONTENT}$([ "$EVENT" = "release" ] && echo " ‚Äî ${RELEASE_TAG} ${RELEASE_NAME}" || echo "")",
            "embeds": [
              {
                "title": "${TITLE_ESC}",
                "url": "${URL}",
                "description": "${BODY_ESC}",
                "color": ${COLOR},
                "fields": ${FIELDS},
                "timestamp": "${TIMESTAMP}"
              }
            ]
          }
          EOF
          )

          # Send to Discord
          curl -H "Content-Type: application/json" -d "$JSON" "$WEBHOOK"
